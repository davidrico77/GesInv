<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">

<div th:include="menus"></div>
<div id="page-wrapper">
<div class="row">
				<div class="col-lg-12">
					<h1 class="page-header" th:text="|${modoTitulo} ANEXO III - MEMORIA JUSTIFICATIVA – ORDEN DE PAGO|"> Viajes</h1>
				</div>
				<!-- /.col-lg-12 -->
			</div>

	<div class="panel panel-default">
		<div class="panel-heading">
			<p class="panel-title">Introduzca valores Viaje</p>
		</div>

		<div class="panel-body">

			<form class="form-horizontal" role="form" action="#"
				th:action="@{'/proyectos/{idProyecto}/{modo}/{idViaje}'  (idProyecto=*{proyecto.id} , modo=${modo}, idViaje=${idViaje})}"
				th:object="${viaje}" method="POST">

				<div class="form-group"
					th:classappend="${#fields.hasErrors('fecha')} ? has-error">
					<label class="control-label col-md-2" for="fecha">Fecha:</label>
					<div class="col-md-2">
						<input class="form-control" th:field="*{fecha}" type="date" /> <span
							class="help-block" th:errors="*{fecha}">[errors]</span>
					</div>
				</div>
				<div class="form-group"
					th:classappend="${#fields.hasErrors('numOrden')} ? has-error">
					<label class="control-label col-md-2" for="numOrden">Num
						Orden:</label>
					<div class="col-md-10">
						<input class="form-control" th:field="*{numOrden}" type="text" />
						<span class="help-block" th:errors="*{numOrden}">[errors]</span>
					</div>
				</div>

				<div class="form-group">
					<label class="control-label col-md-2"
						for=" proyecto.numContabilidad">Nº Contabilidad</label>
					<div class="col-md-10">
						<input class="form-control" th:field="*{proyecto.numContabilidad}"
							type="text" readonly="readonly" />
					</div>
				</div>

<!----------------------------------------------------- INVESTIGADOR PRINCIPAL----------------------------------------------------------->
				<div class="panel panel-default">
					<div class="panel-heading">
						<p class="panel-title">Datos Investigador Principal</p>
					</div>
					<div class="panel-body">
						<div class="form-group">
							<label class="control-label col-md-2" for="user.nombre">Nombre</label>
							<div class="col-md-10">
								<input class="form-control" th:field="${user.nombre}"
									type="text" readonly="readonly" />
							</div>
						</div>

						<div class="form-group">
							<label class="control-label col-md-2" for="user.apellidos">Apellidos</label>
							<div class="col-md-10">
								<input class="form-control" th:field="${user.apellidos}"
									type="text" readonly="readonly" />
							</div>
						</div>

						<div class="form-group">
							<label class="control-label col-md-2"
								for="proyecto.investigadorPrincipal.departamento">Departamento</label>
							<div class="col-md-10">
								<input class="form-control"
									th:value="*{proyecto.investigadorPrincipal.departamento}"
									type="text" readonly="readonly" />
							</div>
						</div>
						<div class="form-group">
							<label class="control-label col-md-2"
								for="proyecto.investigadorPrincipal.centro">Centro</label>
							<div class="col-md-10">
								<input class="form-control"
									th:value="*{proyecto.investigadorPrincipal.centro}" type="text"
									readonly="readonly" />
							</div>
						</div>
						<div class="form-group">
							<label class="control-label col-md-2" for="user.telefono">Teléfono</label>
							<div class="col-md-10">
								<input class="form-control" th:field="${user.telefono}"
									type="text" readonly="readonly" />
							</div>
						</div>
						<div class="form-group">
							<label class="control-label col-md-2" for="user.email">email</label>
							<div class="col-md-10">
								<input class="form-control" th:field="${user.email}" type="text"
									readonly="readonly" />
							</div>
						</div>
					</div>
				</div>
				
<!-----------------------------------------------------FIN  INVESTIGADOR PRINCIPAL----------------------------------------------------------->
				
<!----------------------------------------------------- JUSTIFICACION PARA VIAJES----------------------------------------------------------->
				<div class="panel panel-default">
					<div class="panel-heading">
						<p class="panel-title">JUSTIFICACION PARA VIAJES</p>
					</div>
					<div class="panel-body">
										 
						 <div class="form-group">
						 	<label class="control-label col-md-2" for="relacion">Relacion con el proyecto:</label>
						 	
						 	<div class="radio  col-md-3 ">
										<input  id="miembroRadio" type="radio" value="true" th:field="*{miembroProyecto}">								
										<label   for="miembroRadio">Miembro del proyecto </label>																		
							</div>
														
							<div class="radio  col-md-3">
										<input id="invitadoRadio" type="radio" value="false" th:field="*{miembroProyecto}">								
										<label  for="invitadoRadio">Profesor invitado</label>	
							</div>	
							<div id="inputProfesorInvitado"class="col-md-4 " style="display:none">
									<input class="form-control" th:field="*{invitado}" type="text" placeholder="Ej: Manuel López"/>	
							</div>	
							
							<div id="listaInventigadores" class="col-md-4 ">
												<select id="listaInventigadoresSelect" class="form-control text-center col-md-4" th:field="*{investigador}"	>
													<option value="-1"> -------- Investigadores Proyecto -------- </option>
													<option th:each="user : ${investigadoresAsignadosAproyecto}"
														th:value="${user.id}"
														th:text="|${user.nombre} ${user.apellidos}|">Investigadores</option>
												</select>
												
							</div>
													 						 
						 </div>					
									
						
						 
						<div class="form-group">
							<label class="control-label col-md-2" for="objetoDesplazamiento">Objeto
								del desplazamiento:</label>
							<div class="col-md-10">
								<textarea class="form-control"
									th:field="*{objetoDesplazamiento}"> </textarea>
							</div>
						</div>

						<div class="form-group">
							<label class="control-label col-md-2" for="itinerario">Itinerario:</label>
							<div class="col-md-10">
								<input class="form-control" th:field="*{itinerario}" type="text" />
							</div>
						</div>

						<div class="form-group">
							<label class="control-label col-md-2">Fecha Salida:</label>
							<div class="col-md-2">
								<input type="date" class="form-control"
									th:field="*{fechaInicio}" placeholder="Fecha Salida" />
							</div>
						</div>

						<div class="form-group">
							<label class="control-label col-md-2">Fechas LLegada:</label>
							<div class="col-md-2">
								<input type="date" class="form-control" th:field="*{fechaFin}"
									placeholder="Fecha Llegada" />
							</div>
						</div>
					</div>
				</div>
				
<!----------------------------------------------------- FIN JUSTIFICACION PARA VIAJES----------------------------------------------------------->

<!----------------------------------------------------- JUSTIFICACION DE GASTOS  ----------------------------------------------------------->

				<div class="panel panel-default">
					<div class="panel-heading">
						<p class="panel-title">JUSTIFICACION DE GASTOS</p>
					</div>

					<div class="panel-body">
					
						
						<div class="form-group">
							<label class="control-label col-md-2" for="mediosTransporte">Medios
								de transporte:</label>
							<div class="col-md-3">
								<select name="medios" class="form-control col-md-3" id="mediosTransporte">
								<option value=""> --- Seleccion de Transporte --- </option>
 							 	<option th:each="medio,rowStat : ${T(ucm.fdi.tfg.viajes.business.entity.TipoGasto).values()}" th:if="${rowStat.count} < 7"
 							 	th:value="${{medio}}" th:text="${medio.estado}" ></option>
								
								</select>  
								
							</div>
							<div class="col-md-5">
								<div class="col-md-2">
									<button onclick="appendMedioTransporte()" class="btn btn-success"
										type="button">+</button>
								</div>
							</div>
						</div>
						
						<div class="form-group">
							<label class="control-label col-md-2" for="mediosTransporte">Otros Gastos:</label>
							<div class="col-md-3">
								
								<select name="otrosGastos" class="form-control col-md-3" id="otrosGastos">
								<option value=""> --- Otros Gastos --- </option>
 							 	<option th:each="medio,rowStat : ${T(ucm.fdi.tfg.viajes.business.entity.TipoGasto).values()}" th:if="${rowStat.count} > 6"
 							 	th:value="${{medio}}" th:text="${medio.estado}" ></option>
								
								</select>  
								
							</div>
							<div class="col-md-5">
								<div class="col-md-2">
									<button onclick="appendOtrosGastos()" class="btn btn-success"
										type="button">+</button>
								</div>
							</div>
						</div>
						
						
						
						
						

						<div class="panel-body">
							<table class="table table-bordered ">
								<thead>
									<tr>
										<th class="col-md-2 text-center">Tipo</th>
										<th class="col-md-4 text-center">Descripcion</th>
										<th class="col-md-2 text-center">Factor</th>
										<th class="col-md-2 text-center">KM</th>
										<th class="col-md-2 text-center">Importe</th>
										<th class="col-md-2 text-center">Eliminar</th>										
									</tr>
								</thead>
								
								
								<tbody id="gastos">		
								
									<tr th:each="gasto,gastoStat : *{gastos}" th:id="'gasto' + ${gastoStat.index}" >
											
											<td class="col-md-2" th:classappend="${#fields.hasErrors('gastos[__${gastoStat.index}__].tipo')} ? has-error">	
												<input type="text" class="form-control"  
													th:field="*{gastos[__${gastoStat.index}__].tipo}" readonly="readonly"/>
																					
												
											</td>
											
											<td class="col-md-5" th:classappend="${#fields.hasErrors('gastos[__${gastoStat.index}__].descripcion')} ? has-error">
												<input type="text"
													class="form-control" 
													th:field="*{gastos[__${gastoStat.index}__].descripcion}"  readonly="readonly" />
												
											</td>
											
											<td>
											
											</td>
											
											<td>
											
											</td>								
											
											
											<td class="col-md-2"th:classappend="${#fields.hasErrors('gastos[__${gastoStat.index}__].importe')} ? has-error">
												<input type="text"
													class="form-control" 
													th:field="*{gastos[__${gastoStat.index}__].importe}" readonly="readonly"/>
												
											</td>
											
																					
											<td class="col-md-2">
												<button th:id="'btnMenos' + ${gastoStat.index}" onclick="removeText(this.id)" class="btn btn-danger form-control"
													type="button" >-</button>
											</td>
										</tr>								
														
								</tbody>
								
								
								
								
							</table>

						</div>

					</div>
					
					<div class="panel-body">
							<table  class="table">
								<thead>
									<tr>
										<th class="col-md-2 text-center">Num Dieta</th>
										<th class="col-md-4 text-center">Pais</th>
										<th class="col-md-2 text-center">Importe</th>									
									</tr>
								</thead>
								<tbody id="dietas">
									<tr id="dietas" >
											<td class="col-md-2  ">	
												<input type="text" class="form-control text-center" th:field="*{numDietas}" id="numDietas" value="1" onchange="actualizarImporteDietas();" />																				
											</td>
											<td class="col-md-4">
												<select class="form-control col-md-4" id="listaDietas" th:field="*{dietaID}" >
													<option th:each="dieta : ${dietas}" th:attr="data-importe=${dieta.importe}" 
														th:value="${dieta.id}" th:text="${dieta.pais}"></option>
												</select>
												
											</td>
											<td class="col-md-2"  >
												<input type="text"	class="form-control text-center " id="importeDietaTotal" th:field="*{importeDietaTotal}" readonly="readonly"/>
											</td>					
											
										</tr>
								
								</tbody>

							</table>

						</div>

					<div class="panel-body">

						<div class="input-group col-xs-3">							
							<input type="text" id="gastoTotal" value=0 readonly="readonly"
								class="form-control text-center" aria-label="Amount (to the nearest dollar)">									
							<span class="input-group-addon">$</span> 		
										
						</div>
						<span class="help-block">Gastos Totales.</span>	
					</div>


				</div>
				
<!----------------------------------------------------- FIN JUSTIFICACION DE GASTOS  ----------------------------------------------------------->				
				
				<div class="form-group">
							<label class="control-label col-md-2" for="pagarA">Pagar a:</label>
							<div class="col-md-10">
								<input class="form-control" th:field="*{pagarA}" type="text" />
							</div>
				</div>
				
				<div class="form-group">
							<label class="control-label col-md-2" for="observaciones">Observaciones:</label>
							<div class="col-md-10">
								<textarea class="form-control" th:field="*{observaciones}" ></textarea>
							</div>
				</div>
				

				<!-- Change this to a button or input when using this as a form -->
				<button type="submit" class="btn btn-lg btn-success btn-block" th:text="${modoTitulo}" ></button>
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

			</form>

		</div>

	</div>
	</div>
	


<div th:include="scripts"></div>

<script type="text/javascript">

	/*
	*	Función que actualiza el input del importe Total acumulado de todos los gastos
	*/
	function actualizarImporteTotalGastos() {
		 
		 var acu = 0;
		
		 //Recorremos todos los input que contienen en su atributo name la cadena importe.
		 $("input[name*=importe]").each(function(){
	
		 	acu = acu + Number($(this).val());
		 });	
	
		 $('#gastoTotal').val(acu);		 
	 } 
	
</script>

 <script type="text/javascript">
 
 function removeText(idBotonMenos) {
		
		var totalGastos = $('#gastos tr').length;	
		
		//La posicion 8 del id guarda el numero de gasto
		var numGasto = idBotonMenos.charAt(8);
		
		//Se pasa a numero
		var posCambio = Number(numGasto) + 1; 
		
		//Elimino tr
		$('#gasto'+numGasto).remove();
		
		//A partir del tr eliminado, renombro names e ids
		for (posCambio; posCambio < totalGastos; posCambio++){ 
			
			//Disminuye en uno el name
			document.getElementsByName('gastos['+posCambio+'].tipo')[0].setAttribute('name','gastos['+(posCambio-1)+'].tipo');
			document.getElementsByName('gastos['+posCambio+'].descripcion')[0].setAttribute('name','gastos['+(posCambio-1)+'].descripcion');
			document.getElementsByName('gastos['+posCambio+'].importe')[0].setAttribute('name','gastos['+(posCambio-1)+'].importe');
			
			//Disminuye en uno el id de los botones
			document.getElementById('btnMenos'+posCambio).setAttribute('id','btnMenos'+(posCambio-1));
			
			//Disminuye en uno el id del tr
			document.getElementById('gasto'+posCambio).setAttribute('id','gasto'+(posCambio-1));				
		}	
		
		this.actualizarImporteTotalGastos();
	}
	
 </script>
 

 <script type="text/javascript">

		$("input[name=miembroProyecto]").change(function() {
				
			var radioPulsado = $(this).val();
			
			if (radioPulsado == "true"){						
							
				//ocultamos div que contiene el input de profesor invitado
				$('#invitado').val('');
				$('#inputProfesorInvitado').hide();
				
				//mostramos div que contiene la lista de investigadores
				$('#listaInventigadores').show();						
			}else {//es invitado				
				
				$("#listaInventigadoresSelect option:nth-child(1)").prop('selected', true);
				
				$('#listaInventigadores').hide();
				$('#inputProfesorInvitado').show();
			}				
		});
	</script>


<script th:inline="javascript">
function calcularImporte(input){
	var importePrecioKm = /*[[${importePrecioKm}]]*/ 0.19;
	var valor = importePrecioKm * Number(input.value) ;
	
	$('#'+input.name).val(valor);	
	
	this.actualizarImporteTotalGastos();
	
}
</script>

<script th:inline="javascript">

	/**
	*
	*/
	function appendOtrosGastos(){
		
		if ( $('#otrosGastos').val() !=  "")
		{				
			
			var count = $('#gastos tr').length;
			var nuevoGasto;
			
			if (count ==0)
				nuevoGasto = $(' <tr id="gasto0" th:each="gasto,gastoStat : *{gastos}"> ');
			else
				nuevoGasto = $('<tr></tr>');
			
			var auxTipo = $('<td class="col-md-2"></td>');
			var auxDescripcion = $('<td class="col-md-2"></td>');
			var auximporte = $('<td class="col-md-2"></td>');
			
			//Campos no significativos para la entity
			var auxFactor;
			var auxKM;
			
			var importe; 
			
			
				auxFactor = $('<td class="col-md-2"></td>');
				auxKM = $('<td class="col-md-2"></td>');
				importe = $(
				'<input type="text" class="form-control col-md-2 text-center" onchange="actualizarImporteTotalGastos()"/> ').attr('name', 'gastos[' + count + '].importe');
			
				
			//botones
			var auxbtnMenos = $('<td class="col-md-2"></td>');
	
			var tipo= $(
					'<input type="text" class="form-control col-md-2 text-center" readonly="readonly" />').attr({'name': 'gastos[' + count + '].tipo', 'value': document.getElementById("otrosGastos").value});
			
			var descripcion;
			
			descripcion = $('<input type="text" class="form-control col-md-4 text-center" readonly="readonly" />').attr('name', 'gastos[' + count + '].descripcion');
			
						
			var btnMenos = $('<button onclick="removeText(this.id)" class="btn btn-danger form-control" type="button">-</button>').attr('id', 'btnMenos' + count );
		
			$(auxTipo).append(tipo);
			$(auxDescripcion).append(descripcion);
			$(auximporte).append(importe);
			
			//botones
			$(auxbtnMenos).append(btnMenos);
			
			$(nuevoGasto).append(auxTipo);
			$(nuevoGasto).append(auxDescripcion);
			
			//Campos no significativos
			$(nuevoGasto).append(auxFactor);
			$(nuevoGasto).append(auxKM);
			
			$(nuevoGasto).append(auximporte);
			
					
			//botones
			$(nuevoGasto).append(auxbtnMenos);
			
			//idNuevo
			$(nuevoGasto).attr('id', 'gasto' + count);
			
			
			$('#gastos').append(nuevoGasto);
		
			}
	
}
</script>


<script type="text/javascript">

	function appendMedioTransporte(){
		
		if ( $('#mediosTransporte').val() !=  "")
		{				
			
			var count = $('#gastos tr').length;
			var nuevoGasto;
			
			if (count ==0)
				nuevoGasto = $(' <tr id="gasto0" th:each="gasto,gastoStat : *{gastos}"> ');
			else
				nuevoGasto = $('<tr></tr>');
			
			var auxTipo = $('<td class="col-md-2"></td>');
			var auxDescripcion = $('<td class="col-md-2"></td>');
			var auximporte = $('<td class="col-md-2"></td>');
			
			//Campos no significativos para la entity
			var auxFactor;
			var auxKM;
			
			var importe; 
			
			if ($('#mediosTransporte').val() == "COCHE"){
				auxFactor = $('<td class="col-md-2"></td>');				
				auxFactorTD = $('<input type="text" name="factor" readonly="readonly" class="form-control text-center" />').attr('value', 0.19);
				$(auxFactor).append(auxFactorTD);
				auxKM = $('<td class="col-md-2"></td>');
				auxKMTD = $('<input type="text" class="form-control text-center" onchange="calcularImporte(this)"/>').attr('name', 'km'+count);
				$(auxKM).append(auxKMTD);
				//El importe es calculado automaticamente
				importe = $('<input type="text" class="form-control col-md-2 text-center" readonly="readonly"  onchange="actualizarImporteTotalGastos()" /> ').attr({'name': 'gastos[' + count + '].importe', 'id': 'km'+count});
			}
			else {
				auxFactor = $('<td class="col-md-2"></td>');
				auxKM = $('<td class="col-md-2"></td>');
				importe = $(
				'<input type="text" class="form-control col-md-2 text-center" onchange="actualizarImporteTotalGastos()"/> ').attr('name', 'gastos[' + count + '].importe');
			}
				
			//botones
			var auxbtnMenos = $('<td class="col-md-2"></td>');
	
			var tipo= $(
					'<input type="text" class="form-control col-md-2 text-center" readonly="readonly" />').attr({'name': 'gastos[' + count + '].tipo', 'value': document.getElementById("mediosTransporte").value});
			
			var descripcion;
			if ($('#mediosTransporte').val() == "OTROS"){
				descripcion = $('<input type="text" class="form-control col-md-4 text-center " />').attr('name', 'gastos[' + count + '].descripcion');
			}
			else descripcion = $('<input type="text" class="form-control col-md-4 text-center" readonly="readonly" />').attr('name', 'gastos[' + count + '].descripcion');
			
						
			var btnMenos = $('<button onclick="removeText(this.id)" class="btn btn-danger form-control" type="button">-</button>').attr('id', 'btnMenos' + count );
		
			$(auxTipo).append(tipo);
			$(auxDescripcion).append(descripcion);
			$(auximporte).append(importe);
			
			//botones
			$(auxbtnMenos).append(btnMenos);
			
			$(nuevoGasto).append(auxTipo);
			$(nuevoGasto).append(auxDescripcion);
			
			//Campos no significativos
			$(nuevoGasto).append(auxFactor);
			$(nuevoGasto).append(auxKM);
			
			$(nuevoGasto).append(auximporte);
			
					
			//botones
			$(nuevoGasto).append(auxbtnMenos);
			
			//idNuevo
			$(nuevoGasto).attr('id', 'gasto' + count);
			
			
			$('#gastos').append(nuevoGasto);
		
			}
		
	}
		
</script>



<script type="text/javascript">
function redondeo(numero, decimales)
{
	var flotante = parseFloat(numero);
	var resultado = Math.round(flotante*Math.pow(10,decimales))/Math.pow(10,decimales);
	return resultado;
}
</script>

<script type="text/javascript">
    function actualizarImporteDietas() {
   
       var valueSelected = $('#listaDietas option:selected').attr("data-importe");
       
       var importeTotal = Number(valueSelected) * ($('#numDietas').val());
       
       importeTotal = redondeo( importeTotal, 2)
 	  
 	  $('#importeDietaTotal').val(importeTotal);
       
       this.actualizarImporteTotalGastos();
     
    }
</script>

<script >
$('#listaDietas').change(function () {
	    
	actualizarImporteDietas(); 
	  
});
</script>


</body>
</html>




